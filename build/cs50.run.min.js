var CS50=CS50||{};CS50.Run=function(b){this.options=b;if(!this.options.container){throw"Error: You must define a container for run50!"}this.options.defaultLanguage=(b.defaultLanguage===undefined)?"C":b.defaultLanguage;this.options.endpoint=(b.endpoint===undefined)?"":b.endpoint.replace(/\/+$/,"");this.options.languages=(b.languages===undefined)?["C","Java","PHP","Python","Ruby"]:b.languages;this.commands={"text/x-csrc":[{command:"clang file.c",args:"-lcs50 -std=c99 -Wall -Werror -fno-color-diagnostics"},{command:"./a.out",args:""}],"text/x-java":[{command:"javac -J-Xmx128M file.java",args:""},{command:"java -Xmx64M",args:"Class"}],"text/x-php":[{command:"php file.php",args:""}],"text/x-python":[{command:"python file.py",args:""}],"text/x-ruby":[{command:"ruby file.rb",args:""}]};this.extensions={"text/x-csrc":"c","text/x-java":"java","text/x-php":"php","text/x-python":"py","text/x-ruby":"rb"};this.languageNames={C:"text/x-csrc",Java:"text/x-java",PHP:"text/x-php",Python:"text/x-python",Ruby:"text/x-ruby"};this.samples={"text/x-csrc":'#include <cs50.h>\n#include <stdio.h>\n\nint\nmain(int argc, char *argv[])\n{\n    printf("Enter your name: ");\n    string s = GetString();\n    printf("Hello, %s!\\n", s);\n    return 0;\n}\n',"text/x-java":'class Main {\n    public static void main(String[] args) {\n        System.out.println("Hello, run50!");\n    }\n}\n',"text/x-php":'<?php\n\necho "Hello, run50!\\n";\n\n?>\n',"text/x-python":'print "Hello, run50!"',"text/x-ruby":'puts "Hello, run50!"'};var a={editor:'             <div class="run50-container">                 <div class="run50-controls">                     <a href="#" class="btn-run">                        <img class="run-img" src="img/run.png"/>                         <img class="paused-img" src="img/stop.png"/>                      </a>                     <div class="run50-lang-wrapper">                         <select class="run50-lang chzn-select">                             <% for (var i in languages) { %>                                 <option value="<%= languageNames[languages[i]] %>"><%= languages[i] %></option>                             <% } %>                         </select>                    </div>                     <a href="#" class="btn-options">                         <div class="gear-btn"></div>                         <span>Command Line</span>                     </a>                     <div class="run50-options"></div>                     <div class="run50-status">                         <span class="status-text"></span>                         <img class="status-loader" src="img/ajax-bar.gif"/>                     </div>                 </div>                 <div class="run50-split-container">                     <div class="run50-code-container">                         <textarea class="run50-code"><%= samples[languageNames[defaultLanguage]] %></textarea>                     </div>                     <div class="run50-splitter">&equiv;&equiv;&equiv;</div>                     <div class="run50-console-container">                         <pre class="run50-console"><div contenteditable="false" class="run50-input active"></div></pre>                     </div>                 </div>             </div>         ',runOption:'             <label for="<%= cmd.command %>"><%= cmd.command %></label>             <input id="<%= cmd.command %>" type="text" value="<%= cmd.args %>" />             <div class="divider"></div>         '};this.templates={};for(var c in a){this.templates[c]=_.template(a[c])}this.createEditor()};CS50.Run.prototype.createEditor=function(){var d=this;var e=$(this.options.container);e.html(this.templates.editor({defaultLanguage:this.options.defaultLanguage,languages:this.options.languages,languageNames:this.languageNames,samples:this.samples}));this.editor=CodeMirror.fromTextArea(e.find(".run50-code")[0],{indentUnit:4,lineNumbers:true,lineWrapping:true});var c=function(){var f=e.height();e.find(".run50-controls, .run50-splitter, .run50-console-container").each(function(h,j){f-=$(j).outerHeight()});var g=e.width();e.find(".CodeMirror").width(g).height(f);e.find(".CodeMirror-gutter, .CodeMirror-scrollbar, .CodeMirror-scroll").height(f);e.find(".run50-container, .run50-controls, .run50-console-container, .run50-splitter").width(g)};c();$(window).on("resize",function(){c()});e.on("click",".btn-run",function(){if($(this).hasClass("running")){d.socket.emit("SIGINT");e.find(".run50-input.active").before("<br/>")}else{if(!$(this).hasClass("uploading")){$(this).addClass("uploading");$(".run50-status .status-loader").fadeIn();$(".run50-controls").removeClass(".success, .error");d.run()}}});e.on("keyup",".run50-input",function(f){if(f.ctrlKey){if(f.which==67){d.socket.emit("SIGINT");e.find(".run50-input.active").before("<br/>")}else{if(f.which==68){d.socket.emit("EOF")}}}});e.on("change",".run50-lang",function(){d.setLanguage($(this).val())});e.find(".run50-lang").val(this.languageNames[this.options.defaultLanguage]).chosen().trigger("change");e.on("click",".btn-options",function(){$options=e.find(".run50-options");if($options.is(":visible")){e.find(".run50-options").removeClass("active");e.find(".btn-options").removeClass("active")}else{e.find(".run50-options").addClass("active");e.find(".btn-options").addClass("active")}});var a=0;var b=0;e.find(".run50-splitter").draggable({axis:"y",drag:function(g,i){var f=a+i.position.top;var h=b-i.position.top;if(f>100&&h>50){e.find(".CodeMirror, .CodeMirror-gutter, .CodeMirror-scrollbar, .CodeMirror-scroll").height(a+i.position.top);e.find(".run50-console-container").height(b-i.position.top)}else{return false}},start:function(f,g){a=e.find(".CodeMirror").height();b=e.find(".run50-console-container").height()}});e.on("blur",".run50-options [contenteditable]",function(){var f=this;e.find(".run50-options input").each(function(g,h){if(f==this){d.commands[d.language][g].args=$(this).text()}})});e.on("click",".run50-console",function(){$(this).find(".run50-input").focus()});e.on("keypress",".run50-input.active",function(f){if(f.which==13){d.socket.emit("stdin",$(this).text()+"\n");$(this).removeClass("active").attr("contenteditable",false);$console=$(this).parents(".run50-console");$console.append('<div class="run50-input active" contenteditable="true"></div>');$console.find(".run50-input.active").focus()}})};CS50.Run.prototype.execute=function(b){function a(i){i.find(".run50-console").scrollTop(999999)}var g=b.shift();if(g){this.socket=io.connect(this.options.endpoint,{"force new connection":true});var f=$(this.options.container);var h=f.find(".run50-console");var d=f.find(".run50-status .status-text");d.text((b.length)?"Building...":"Running...");f.find(".run50-input.active").text(g).removeClass("active");f.find(".run50-console").append('<div class="run50-input active" contenteditable="true"></div>');f.find(".run50-input.active").focus();a(f);var e=this;this.socket.on("success",function(i){e.socket.disconnect();if(i.code!==0){e.failure($(e.options.container))}else{e.newline(f,b.length===0);if(b.length===0){d.text("Run successful!");setTimeout(function(){f.find(".btn-run").removeClass("uploading running");f.find(".run50-status .status-loader").fadeOut();f.find(".run50-status").addClass("success")},300);setTimeout(function(){if(d.text()=="Run successful!"){$(".run50-status").removeClass("success")}d.fadeOut(function(){d.text("");d.show()})},2000)}else{e.sandbox=i.sandbox;e.execute(b)}}});this.socket.on("error",function(i){e.socket.disconnect();e.failure($(e.options.container),i.error.code)});this.socket.on("stdout",function(j){var i=$("<span>"+j+"</span>");var k=f.find(".run50-input.active").before(i);k.css("text-indent",i.position().left-parseInt($(e.options.container).find(".run50-console").css("padding-left"))+i.width());i.replaceWith(i.text());a(f)});var c="";this.socket.on("stderr",function(i){f.find(".run50-input.active").before(i.toString());a(f)});this.socket.emit("run",{cmd:g,sandbox:this.sandbox})}};CS50.Run.prototype.failure=function(d,b){var a=this;var c="An error occurred.";switch(b){case"E_TIMEOUT":c="Your program took too long to run!";break;case"E_USAGE":c="CS50 Run was used incorrectly";break;case"E_KILLED":c="Your program was terminated!";break;case"E_USER_SERVER_DOWN":c="CS50 Run seems to be down. Wait and try again?";break;case"E_USER_UPLOAD_ERROR":c="Upload failed! Wait and try again?";break}d.find(".run50-status .status-text").text(c);d.find(".run50-status").addClass("error");setTimeout(function(){$(".run50-status").removeClass("error success")},2000);d.find(".btn-run").removeClass("uploading running");d.find(".run50-status .status-loader").fadeOut();a.newline(d,true)};CS50.Run.prototype.getCode=function(){return this.editor.getValue()};CS50.Run.prototype.newline=function(c,b){c.find(".run50-input.active").remove();var d=$('<div class="run50-input active" contenteditable="false"></div>');if(!b){var a=$("<span>jharvard@run.cs50.org (~): </span>");c.find(".run50-console").append(a);d.css("text-indent",a.position().left-parseInt($(this.options.container).find(".run50-console").css("padding-left"))+a.width());a.replaceWith(a.text())}c.find(".run50-console").append(d);scroll(c)};CS50.Run.prototype.run=function(){var a=_.map(this.commands[this.language].slice(0),function(b){return b.command+" "+b.args});this.upload("file."+this.extensions[this.language],a)};CS50.Run.prototype.setLanguage=function(c){var d=$(this.options.container);this.language=c;this.editor.setOption("mode",c);var b=this;var a=d.find(".run50-options").empty();_.each(this.commands[c],function(f){a.append(b.templates.runOption({cmd:f}))})};CS50.Run.prototype.upload=function(a,b){var e=this;var g=$("<span>jharvard@run.cs50.org (~): </span>");var f=$(e.options.container).find(".run50-input.active").before(g);f.css("text-indent",g.position().left-parseInt($(e.options.container).find(".run50-console").css("padding-left"))+g.width());g.replaceWith(g.text());var k=$(e.options.container).find(".run50-status .status-text");k.text("Uploading source code...");var e=this;var c={};c[a]=this.editor.getValue();var j=$(this.options.container);var h=j.find(".btn-run");var d=function(l){i.abort()};var i=$.ajax({data:c,dataType:"json",type:"post",url:this.options.endpoint+"/upload",beforeSend:function(l){h.click(d);setTimeout(function(){if(l.readyState==0){l.abort()}},10000)},success:function(m,n,l){h.removeClass("uploading").addClass("running");e.sandbox={homedir:m.id};e.execute(b)},error:function(o,m,n){var l;if(o.readyState===0||(o.readyState==4&&o.status!==200)){e.failure($(e.options.container),"E_USER_SERVER_DOWN")}else{e.failure($(e.options.container),"E_USER_UPLOAD_ERROR")}},complete:function(l,m){h.unbind("click",d)}});return false};